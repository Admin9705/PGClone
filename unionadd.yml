#!/bin/bash
#
# Title:      PlexGuide (Reference Title File)
# Author(s):  Admin9705 - Deiteq
# URL:        https://plexguide.com - http://github.plexguide.com
# GNU:        General Public License v3.0
################################################################################
---
- hosts: localhost
  gather_facts: false
  tasks:

    - lineinfile:
        path: /opt/appdata/plexguide/rclone.conf
        state: absent
        regexp: '[unionfs]'

    - name: Register HD Path
      shell: "cat /var/plexguide/server.hd.path"
      register: hdpath

    - name: Transport Type
      shell: "cat /var/plexguide/pgclone.transport"
      register: transport55

    - name: 'If Fact Matches - Encrypted Blitz'
      set_fact:
        path: 'remote = gdrive: tdrive: gcrypt: tcrypt: {{hdpath.stdout}}/move'
      when: 'transport55.stdout == "eblitz"'

    - name: 'If Fact Matches - Encrypted Move'
      set_fact:
        path: 'remote = gdrive: gcrypt: {{hdpath.stdout}}/move'
      when: 'transport55.stdout == "emove"'

    - name: 'If Fact Matches - UnEncrypted Blitz'
      set_fact:
        path: 'remote = gdrive: tdrive: {{hdpath.stdout}}/move'
      when: 'transport55.stdout == "ublitz"'

    - name: 'If Fact Matches - UnEncrypted Move'
      set_fact:
        path: 'remote = gdrive: {{hdpath.stdout}}/move'
      when: 'transport55.stdout == "umove"'

    - name: Transport Type
      shell: 'echo "" >> /opt/appdata/plexguide/rclone.conf'
      register: transport

    - name: Transport Type
      shell: 'echo "[unionfs]\ntype = union\n{{path}}" >> /opt/appdata/plexguide/rclone.conf'
      register: transport

    - name: 'PG Blitz Execution'
      block:

      - name: Bandwidth Limit
        shell: "cat /var/plexguide/blitz.bw"
        register: bandwidth

      - name: Install pgblitz script
        template:
          src: /opt/pgclone/templates/pgblitz.sh
          dest: /opt/appdata/pgblitz/pgblitz.sh
          force: yes

      - name: Install pgblitz Service
        template:
          src: /opt/pgclone/templates/pgblitz.service
          dest: /etc/systemd/system/pgblitz.service
          force: yes

      - name: Enable pgblitz Service
        systemd:
          daemon_reload: yes
          enabled: yes
          state: restarted
          name: pgblitz

      when: ('transport55.stdout == "eblitz"') or
            ('transport55.stdout == "ublitz"')
